<html>

<head>
  <title>Pokemon Go Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="css/styles.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="js/test.js"></script>
  <script src="js/gyms.js"></script>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  <script>
    var pogomap,
      marker,
      markersArray = [],
      group,
      popup = L.popup(),
      dialog;

    $(document).ready(function() {
      pogomap = L.map('mapid');
      pogomap.setView([52.379189, 4.899431], 15);

      // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZHJhZ29uZHJhYWsiLCJhIjoiY2pnOWFtZjd4MDhybTJxbzVrdmMxaHRpNyJ9.6dUslZn7O2Md69_eZA1Q_A', {
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '',
        accessToken: 'pk.eyJ1IjoiZHJhZ29uZHJhYWsiLCJhIjoiY2pnOWFtZjd4MDhybTJxbzVrdmMxaHRpNyJ9.6dUslZn7O2Md69_eZA1Q_A',
        id: 'mapbox.streets'
      }).addTo(pogomap);

      var uncontested = L.icon({
        iconUrl: 'images/Uncontested.png',
        iconSize: [48, 48]
      });

      for (var i = 0; i < gyms.length; i++) {
        L.marker([gyms[i][7], gyms[i][8]], {
            id: gyms[i][0],
            raid_status: gyms[i][1],
            raid_timer: gyms[i][2],
            raid_level: gyms[i][3],
            lure_timer: gyms[i][4],
            titleDashed: gyms[i][5],
            title: gyms[i][6],
            icon: uncontested,
            virtual: true
          })
          // .bindPopup(gyms[i][0] + ': ' + gyms[i][6])
          .bindPopup('marker ' + i)
          .addTo(pogomap)
          .on('click', onMarkerClick);

        // markersArray.push(marker);
      }

      pogomap.on('resize moveend zoomend', function() {
        var markers = document.querySelectorAll('#map .leaflet-marker-pane *');
        var shadows = document.querySelectorAll('#map .leaflet-shadow-pane *');
        document.querySelector('#visible').innerText = markers.length + "/" + shadows.length;
        // console.log(pogomap.getBounds());
      });

      // create a red polyline from an array of LatLng points
      var latlngs = [
        [
          [52.358124, 4.87391],
          [52.357932, 4.873287],
          [52.3579, 4.873157],
          [52.357834, 4.872718],
          [52.35777, 4.872483],
          [52.357638, 4.872244],
          [52.357658, 4.872091],
          [52.357705, 4.872015],
          [52.357619, 4.871696],
          [52.357564, 4.871712],
          [52.357475, 4.871629],
          [52.357473, 4.871432],
          [52.357443, 4.871251],
          [52.357218, 4.870599],
          [52.35715, 4.870347],
          [52.357238, 4.870259],
          [52.357136, 4.86997],
          [52.357072, 4.870031],
          [52.356968, 4.869548],
          [52.356879, 4.86924],
          [52.356539, 4.868397],
          [52.356412, 4.867885],
          [52.356417, 4.867795],
          [52.356457, 4.867742],
          [52.356419, 4.867571],
          [52.356374, 4.867563],
          [52.356331, 4.867513],
          [52.356252, 4.867198],
          [52.35609, 4.86714],
          [52.355925, 4.867262],
          [52.35583, 4.867039],
          [52.355799, 4.867019],
          [52.355472, 4.867252],
          [52.355229, 4.867379],
          [52.355209, 4.867338],
          [52.355219, 4.867332],
          [52.355167, 4.867094],
          [52.355005, 4.867071],
          [52.354903, 4.867018],
          [52.354823, 4.866929],
          [52.35478, 4.866865],
          [52.354771, 4.866819],
          [52.354776, 4.866767],
          [52.354809, 4.866705],
          [52.354984, 4.866629],
          [52.35504, 4.866562],
          [52.355078, 4.866471],
          [52.355104, 4.86629],
          [52.35507, 4.865906],
          [52.355072, 4.865579],
          [52.355129, 4.865245],
          [52.355278, 4.86485],
          [52.355493, 4.864413],
          [52.355607, 4.864052],
          [52.355705, 4.863537],
          [52.355728, 4.862918],
          [52.355707, 4.862442],
          [52.355636, 4.861926],
          [52.355594, 4.861749],
          [52.355426, 4.861282],
          [52.355269, 4.861],
          [52.354947, 4.860603],
          [52.35467, 4.860201],
          [52.354544, 4.859941],
          [52.354251, 4.859196],
          [52.354134, 4.858993],
          [52.354015, 4.858843],
          [52.354053, 4.858668],
          [52.35421, 4.858678],
          [52.354307, 4.858633],
          [52.354367, 4.858562],
          [52.354483, 4.858305],
          [52.354552, 4.857958],
          [52.354606, 4.857766],
          [52.354696, 4.857555],
          [52.35475, 4.857506],
          [52.354788, 4.85751],
          [52.35482, 4.857545],
          [52.354841, 4.85763],
          [52.35489, 4.857618],
          [52.354856, 4.857327],
          [52.354632, 4.856593],
          [52.354601, 4.85641],
          [52.354588, 4.856239],
          [52.354591, 4.856014],
          [52.354607, 4.855861],
          [52.35464, 4.855776],
          [52.354683, 4.855731],
          [52.354728, 4.855717],
          [52.354786, 4.85574],
          [52.354836, 4.855814],
          [52.355007, 4.855704],
          [52.355017, 4.855667],
          [52.356306, 4.855029],
          [52.356396, 4.8551],
          [52.357395, 4.858947],
          [52.357597, 4.859789],
          [52.358124, 4.861827],
          [52.358156, 4.861818],
          [52.358254, 4.862244],
          [52.358282, 4.862225],
          [52.358615, 4.863652],
          [52.358584, 4.863672],
          [52.358925, 4.865108],
          [52.358913, 4.865114],
          [52.358926, 4.865171],
          [52.35894, 4.865166],
          [52.358988, 4.865365],
          [52.358997, 4.865408],
          [52.358982, 4.865421],
          [52.359644, 4.86821],
          [52.360114, 4.869969],
          [52.35997, 4.870066],
          [52.36027, 4.871252],
          [52.360189, 4.871308],
          [52.360234, 4.871481],
          [52.360528, 4.871281],
          [52.360554, 4.871385],
          [52.360343, 4.871544],
          [52.360329, 4.871784],
          [52.360395, 4.872184],
          [52.360494, 4.872579],
          [52.360735, 4.873318],
          [52.360726, 4.873567],
          [52.360751, 4.873701],
          [52.360822, 4.873823],
          [52.360878, 4.873852],
          [52.360968, 4.873855],
          [52.361008, 4.874022],
          [52.361041, 4.874008],
          [52.361043, 4.874058],
          [52.361179, 4.874189],
          [52.361166, 4.874228],
          [52.36119, 4.874251],
          [52.361164, 4.874329],
          [52.361181, 4.874345],
          [52.361147, 4.874415],
          [52.361107, 4.874389],
          [52.3611, 4.87441],
          [52.361131, 4.87444],
          [52.361086, 4.87456],
          [52.361259, 4.874759],
          [52.361187, 4.875],
          [52.361233, 4.875037],
          [52.361149, 4.875294],
          [52.361127, 4.875276],
          [52.361105, 4.875351],
          [52.361121, 4.875386],
          [52.361114, 4.875418],
          [52.361015, 4.875468],
          [52.360962, 4.875617],
          [52.360972, 4.875627],
          [52.360959, 4.875667],
          [52.360948, 4.875657],
          [52.360935, 4.875705],
          [52.360807, 4.875619],
          [52.360753, 4.875834],
          [52.360703, 4.875874],
          [52.360793, 4.87619],
          [52.360724, 4.876264],
          [52.360786, 4.876501],
          [52.36061, 4.8766],
          [52.360599, 4.87663],
          [52.360582, 4.876618],
          [52.36056, 4.876661],
          [52.360644, 4.876959],
          [52.360675, 4.876937],
          [52.360697, 4.877041],
          [52.360732, 4.877023],
          [52.360722, 4.876989],
          [52.360759, 4.876945],
          [52.360753, 4.876894],
          [52.360794, 4.876884],
          [52.36079, 4.876868],
          [52.3609, 4.876791],
          [52.360929, 4.876792],
          [52.360924, 4.876774],
          [52.360958, 4.876835],
          [52.361063, 4.877214],
          [52.36085, 4.877364],
          [52.360857, 4.877393],
          [52.360767, 4.877459],
          [52.361817, 4.881305],
          [52.361533, 4.882124],
          [52.361488, 4.88215],
          [52.361443, 4.882103],
          [52.360982, 4.880339],
          [52.360947, 4.880363],
          [52.360221, 4.877557],
          [52.360291, 4.877502],
          [52.360303, 4.877514],
          [52.360331, 4.877468],
          [52.360325, 4.877449],
          [52.360355, 4.877383],
          [52.360369, 4.877284],
          [52.360358, 4.877158],
          [52.360343, 4.877168],
          [52.360405, 4.877118],
          [52.360331, 4.876819],
          [52.360267, 4.876862],
          [52.360269, 4.876824],
          [52.36023, 4.876747],
          [52.360187, 4.8767],
          [52.360129, 4.876679],
          [52.360125, 4.876659],
          [52.360087, 4.876656],
          [52.360085, 4.876681],
          [52.360053, 4.876684],
          [52.360003, 4.876732],
          [52.359899, 4.876491],
          [52.359679, 4.87577],
          [52.359613, 4.875817],
          [52.359618, 4.875838],
          [52.359606, 4.875826],
          [52.359388, 4.87598],
          [52.359199, 4.875257],
          [52.359213, 4.875247],
          [52.35917, 4.875084],
          [52.358886, 4.875284],
          [52.358869, 4.875331],
          [52.358767, 4.87539],
          [52.358665, 4.875006],
          [52.358459, 4.875155],
          [52.358124, 4.87391]
        ],
        [
          [52.359006, 4.866372],
          [52.358926, 4.866328],
          [52.358827, 4.866317],
          [52.358749, 4.86634],
          [52.358715, 4.866386],
          [52.358697, 4.866461],
          [52.358679, 4.866785],
          [52.35864, 4.867033],
          [52.358428, 4.867599],
          [52.358375, 4.867825],
          [52.358334, 4.868208],
          [52.358346, 4.868448],
          [52.358363, 4.868577],
          [52.358467, 4.868589],
          [52.358568, 4.868653],
          [52.358733, 4.868884],
          [52.358848, 4.868777],
          [52.358865, 4.868866],
          [52.359176, 4.869749],
          [52.35922, 4.86983],
          [52.359282, 4.869871],
          [52.35941, 4.869877],
          [52.359507, 4.869823],
          [52.359589, 4.869739],
          [52.359642, 4.869616],
          [52.359671, 4.869466],
          [52.359668, 4.869381],
          [52.359621, 4.869116],
          [52.359572, 4.868932],
          [52.359413, 4.868546],
          [52.359223, 4.8682],
          [52.359152, 4.867994],
          [52.359118, 4.867645],
          [52.359109, 4.866766],
          [52.359068, 4.866503],
          [52.359006, 4.866372]
        ]
      ];
      var polyline = L.polyline(latlngs, {
        color: 'red'
      }).addTo(pogomap);
      // zoom the map to the polyline
      pogomap.fitBounds(polyline.getBounds());

      // $.getJSON('php/gyms.php', function(json) {
      //   $.each(json, function(i, item) {
      //     console.log(item);
      //     // console.log(item.id, [item.latitude, item.longitude], item.name);

      //     marker = new L.marker([item.latitude, item.longitude], {
      //         id: item.id,
      //         raid_status: '',
      //         raid_timer: '',
      //         raid_level: '',
      //         lure_timer: '',
      //         titleDashed: '',
      //         title: item.name,
      //         icon: uncontested,
      //       })
      //       // .bindPopup(gyms[i][0] + ': ' + gyms[i][6])
      //       .addTo(pogomap)
      //       .on('click', onMarkerClick);
      //   });
      // });

      dialog = $('#dialog').dialog({
        autoOpen: false,
        height: 400,
        width: 500,
        modal: true,
        draggable: false,
        buttons: {
          Ok: function() {
            $(this).dialog("close");
          },
          Cancel: function() {
            dialog.dialog('close');
          }
        },
        close: function() {}
      });

      L.Marker.addInitHook(function() {
        if (this.options.virtual) {
          // setup virtualization after marker was added
          this.on('add', function() {
            this._updateIconVisibility = function() {
              var map = this._map,
                isVisible = map.getBounds().contains(this.getLatLng()),
                wasVisible = this._wasVisible,
                icon = this._icon,
                iconParent = this._iconParent,
                shadow = this._shadow,
                shadowParent = this._shadowParent;

              // remember parent of icon 
              if (!iconParent) {
                iconParent = this._iconParent = icon.parentNode;
              }
              if (shadow && !shadowParent) {
                shadowParent = this._shadowParent = shadow.parentNode;
              }

              // add/remove from DOM on change
              if (isVisible != wasVisible) {
                if (isVisible) {
                  iconParent.appendChild(icon);
                  if (shadow) {
                    shadowParent.appendChild(shadow);
                  }
                } else {
                  iconParent.removeChild(icon);
                  if (shadow) {
                    shadowParent.removeChild(shadow);
                  }
                }
                this._wasVisible = isVisible;
              }
            };

            // on map size change, remove/add icon from/to DOM
            this._map.on('resize moveend zoomend', this._updateIconVisibility, this);
            this._updateIconVisibility();
          }, this);
        }
      });
    });

    function onMarkerClick(e) {
      console.log(e);
      // popup
      //   .setLatLng(e.latlng)
      //   .setContent("You clicked the map at " + e.latlng.toString())
      //   .openOn(pogomap);
      dialog
        .html(JSON.stringify(e.target.options))
        .dialog({
          title: e.target.options.title
        })
        .dialog('open');
    }
  </script>
</head>

<body>
  <div id="visible"></div>
  <div id="mapid"></div>
  <div id="dialog"></div>
</body>

</html>